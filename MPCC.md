# MPCC

模型预测轮廓控制MPCC主要的思想是：通过控制而非规划实现时间最优，由此突破时间最优轨迹在经过控制后退化为次优、同时规划和控制同时加重计算负担的问题。

MPCC之所以能实现时间最优，是因为以**进度（轨迹长度）**作为轨迹的自变量而非时间，通过进度最优实现时间最优；同时，进度提供了便捷地轨迹误差计算方法，尤其是切线和投影的计算，轮廓控制相比于传统的MPC跟踪控制具有更强的适应性。

因为时间最优环节后移至控制，使得轨迹生成可以尽可能的简化，同时还能保证经历优化后的输出仍然最优。

## 优化函数结构

$$
\pi(x)=argmin \sum_{k=0}^N J\\
J=J_{MPCC}+J_{dynamic}\\
=J_{contour}+J_{progress}+J_{dynamic}\\
=q_c(||p_k-p^d(\theta_k)||_{proj})^2-\mu \theta_k+J_{dynamic}\\
=(||e^c(\theta_k)||^2_{q_c}+||e^l(\theta_k)||^2_{q_l})-\mu v_{\theta,k}+(||\Delta f||^2_{R_{\Delta f}}+||\Delta v_{\theta_k}||^2_{r_{\Delta v}}+||\omega_k||^2_{Q_{\omega}})\\
约束：x_0确定,x_{k+1}=f(x_k,u_k),\{\omega,f,v_\theta,\Delta v_\theta,\Delta f\}均有界
$$

MPCC主要指的就是对轮廓代价$q_c(||p_k-p^d(\theta_k)||_{proj})^2$优化，其指当前点$p_k$到轨迹的垂线段长度平方，使其最小化即可控制机体始终沿轨迹；而时间最优体现在进度项$-\mu \theta_k$，因为希望其越大越好，在最小化函数中需要负相关因此有负号。而运动代价则是为了稳定性，处于工程实现目的增设的。

同时值得注意的是，整个优化对象实际上是一个积分式，即开头的求和。

代价函数最后一行对应了实际计算方式，将会由下方推导。

## 进度相关计算方法

要能计算轮廓代价，首先要能获得进度，也就是$\theta_k$，这当然依赖于轨迹；因此首先要通过轨迹计算出一系列的离散进度$\theta_k$，在利用之反过来将轨迹进度参数化，把轨迹从$p(t),p(k)$统一转换为$p(\theta_k)$.

- 对于离散轨迹，进度可以轻易地利用线性假设计算，即将两点间直线距离作为$\Delta \theta$；而对于连续轨迹，就可以使用更精准的方法，利用二分法将轨迹不断划分，即可保证最后每一段$\Delta \theta$都相同。两种计算方法都是对曲线积分$\theta_k=\int_0^kp(k)dk$的近似和离散化.
- 不管如何，最后得到的轨迹都是一个离散的分段函数$p(\theta)=\rho_k,\theta\in[\theta_k,\theta_{k+1}]$，每段包含了位置、进度和标准化速度。

其次就是如何计算点到曲线的距离，因为$p(\theta_k)$与$p_k$对应，但直接对这个距离优化反而会拖慢进度：正是因为允许$p_k$超前，才有时间最优可言，因此转而只对点到曲线的距离约束。然而，直接求解计算量极大，转换为$min||p_k-p^d(\theta_k)||$也相当于增设了一个优化问题，那么可以采用$p_k-p^d(\theta_k)$在$p^d(\theta_k)$出曲线法平面的投影长度$||e^c(\theta_k)||$近似，条件是$e^l(\theta_k)=e-e^c$趋近于0，因此将二者都作为最小值优化的代价即可实现，得到。
$$
J_{contour}=||e^c(\theta_k)||^2_{q_c}+||e^l(\theta_k)||^2_{q_l}\\
其中，\lim_{e^l\rightarrow0}e^c=distance(p_k,p^d)
$$
然而，对于进度，代价函数并不能直接使用$\theta$，因为代价本身是对$k$的积分，因此在代价中$\theta$应转换为其微分的形式$v_{\theta_k}$，就得到：
$$
J_{progress}=-\mu v_{\theta_k}\\
其中，v_{\theta_k}=\frac{\Delta \theta_k}{\Delta t}
$$
至此，优化函数的自变量完全是进度，但这导致动力学约束$x_{k+1}=f(x_k,u_k)$难以直接作用其上，一个合理的选择就是将进度及其微分加入状态和控制量中，并和其他物理量一样配套上下界约束。因为进度的微分就是速度的代数值，因此可以认为进度与位置同级，将进度和进度的一阶微分加入状态变量，而二阶微分加入控制变量。
$$
x=[p,q,v,\omega,f,\theta]\\
u=[\Delta v,\Delta f]
$$
因此，理论上的优化问题已经完整了。然而在工程应用中，我们不得不再在优化项中加入$||x||^2$和$||u||^2$项，以保证状态尽量问题、输出足够平滑。而为了不影响轮廓控制，状态中加入的项应该尽量少，而从整体的角度看，轮廓控制已经涉及对$p$的优化，对于姿态没有控制，因此$||\omega||^2$称为保证稳定性的必须项，即$||\omega_k||^2_{Q_{\omega}}$；同时相比于状态量允许一定的激进型，控制量的噪音会对效果带来巨大的影响，因此需要对整个控制量进行优化，即加入$||\Delta f||^2_{R_{\Delta f}}+||\Delta v_{\theta_k}||^2_{r_{\Delta v}}$

至此优化问题的计算方式也全部解决。注意，实际计算时动力学约束$x_{k+1}=f(x_k,u_k)$也是需要离散化计算的.

## 轨迹生成方法

MPCC推荐了三种轨迹，即最小snap轨迹，CPC轨迹和PMM轨迹，其中PMM，即点质量模型轨迹正是RPG实验室同年发布的规划方面的论文。由于时间最优已经可以在控制层面得到保证，然而控制的效果仍然受到轨迹好坏的影响，因此MPCC仍然需要一个能快速生成优质轨迹的轨迹生成方法。min-snap为代表的多项式轨迹计算快速，但难以满足时间要求；CPC能够直接生成理论最优解，但计算速度太慢。

然而MPCC为轨迹生成提供了一个转机：

- 时间最优问题常常受制于时间、路点、运动学三重约束的互相掣肘：多种软约束一股脑一起优化会导致无法时间最优或不可解，但分布和简化又会影响最终解的质量。一个普遍的思路是，每次优化的结果作为下一次优化的初始解，即使下一次优化中仍然带有多重约束，但因为初始解本身已经满足了部分约束，从而大大提高计算效率和成功率。然而优化函数分步后的多个优化问题串接仍然面临计算时间问题。
- MPCC不依赖于轨迹的可行性，即使轨迹不可行，也能尽可能实现跟踪。因此，在轨迹生成中，运动学约束可以尽可能简化，从而大大解放了时间最优轨迹生成的难度。

因此运动学约束可以将运动学简化为点质量模型，控制方法由上下界内连续值简化为bang-bang二值控制，使得运动学约束不仅大大简化，甚至根据首尾点坐标和速度直接求出时间最优控制的闭式解，这为时间优化又带来了意想不到的转机：由于可以求出路劲确切的时间代价，可以考虑对路点采样速度的方式生成采样路劲，每一条路劲的时间代价都可以确定，从而利用Dijkstra算法图搜索出最短代价路劲，对应的速度-路点组合就成为时间最优轨迹。至此，时间最优问题就转化为图搜索问题。

要能找到最优解，采样密度需要足够高，然而通过提高采样密度解最优问题，本质上就和普通的优化方法没有区别了，而采样提供了一个更有效率的搜索方法。通过多级搜索，每次搜索都只对上一次搜索的最优解周围搜索，逐步细化到最优解，即迭代启发算法，或称重聚焦法。
